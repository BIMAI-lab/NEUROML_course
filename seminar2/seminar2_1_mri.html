

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>MRI data analysis, sources databases, tools &#8212; Neuroimaging and Machine Learning for Biomedicine</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'seminar2/seminar2_1_mri';</script>
    <link rel="shortcut icon" href="../_static/logo.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Transformations" href="seminar2_2_transform.html" />
    <link rel="prev" title="Seminar 1. EEG analysis" href="../seminar1/seminar1-working-with-eeg.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to the Neuroimaging and Machine Learning for Biomedicine coursebook
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../bio/intro_links.html">Links</a></li>
<li class="toctree-l1"><a class="reference external" href="https://colab.research.google.com/drive/1AM67Sd37J0hIJ-kLyzAZRm8op_JcUQ9b?usp=sharing">Intro to shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../seminar0/Seminar1_python_colab.html">How to work with Python</a></li>




<li class="toctree-l1"><a class="reference internal" href="../seminar0/Seminar1_ML.html">Intro to ML</a></li>


















<li class="toctree-l1"><a class="reference internal" href="../seminar0/00_pytorch_fundamentals.html">Pytorch fundamentals</a></li>
<li class="toctree-l1"><a class="reference external" href="https://drive.google.com/file/d/1q0XncKq2y_wHLXJaxhjfBCDGHABmzrjM/view?usp=sharing">Intro to computer vision</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Seminar 1. Working with EEG</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../seminar1/seminar1-working-with-eeg.html">Seminar 1. EEG analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Seminars 2-3. Working with MRI</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Seminar 2.1. MRI data analysis, databases and tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="seminar2_2_transform.html">Transformations</a></li>





<li class="toctree-l1"><a class="reference internal" href="seminar2_3_freesurfer.html">FREESURFER</a></li>


<li class="toctree-l1"><a class="reference external" href="https://colab.research.google.com/drive/1i0f49198_Jb4fp-dw-8Dl46S8gKRyO8A?usp=sharing">Seminar 3.1. MRI classification on morphometry data</a></li>
<li class="toctree-l1"><a class="reference external" href="https://colab.research.google.com/drive/1fUSEvtxTgWYatJTBa1kHjKQU2vUW0V3v?usp=sharing">Seminar 3.2. MRI classification with 3D CNN</a></li>
<li class="toctree-l1"><a class="reference external" href="https://colab.research.google.com/drive/19yE-7yJDztLJHCvxFgMR6rGH-A3MFjsM?usp=sharing">Seminar 3.3. MRI segmentation with 3D U-net</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Seminar 4-6. Working with fMRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference external" href="https://colab.research.google.com/drive/1V3pLq3B_AdMFBL3EVJD9VFU7GJ0PvAA5?usp=sharing">Seminar 5. Functional connectivity</a></li>
<li class="toctree-l1"><a class="reference external" href="https://colab.research.google.com/drive/1elqHcFpcx1_QX4jhbNihM0whPgfJzBV3?usp=sharing">Seminar 6.1. Extract ICA components from fMRI data</a></li>
<li class="toctree-l1"><a class="reference external" href="https://colab.research.google.com/drive/1zFSdOD0HkhTi9r2l4t_pbW--FFgTK9fm?usp=sharing">Seminar 6.2. Deep Learning methods for fMRI data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Seminar 7. Interpretation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference external" href="https://colab.research.google.com/drive/1sJtU1uWezC-hEpDSkyhl0toioOt3F8FF?usp=sharing">Seminar 7. Interpretation of 3D CNNs for Brain MRI Data Classification</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/BIMAI-lab/NEUROML_course" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/BIMAI-lab/NEUROML_course/issues/new?title=Issue%20on%20page%20%2Fseminar2/seminar2_1_mri.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/seminar2/seminar2_1_mri.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>MRI data analysis, sources databases, tools</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plan">PLAN:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mri-file-formats">1) MRI File Formats</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dicom-file-format">DICOM file format</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-manipulations">Data manipulations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nifti-file-format">Nifti File Format</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nifti-header">Nifti Header</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mgh-file-format">MGH File Format</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="mri-data-analysis-sources-databases-tools">
<h1>MRI data analysis, sources databases, tools<a class="headerlink" href="#mri-data-analysis-sources-databases-tools" title="Permalink to this headline">#</a></h1>
<section id="plan">
<h2>PLAN:<a class="headerlink" href="#plan" title="Permalink to this headline">#</a></h2>
<ol class="arabic simple">
<li><p><strong>MRI data formats</strong> \</p></li>
<li><p><strong>accessing data voxel and meta data</strong> \</p></li>
<li><p><strong>transformations</strong> \</p></li>
<li><p><strong>preprocessing</strong> \</p></li>
<li><p><strong>visualization</strong></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !apt update</span>
<span class="c1"># !apt install -y libtiff5</span>
<span class="c1"># !conda install -y -c conda-forge matplotlib</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from pydicom.data import get_testdata_files</span>
<span class="c1"># import matplotlib.pyplot as plt</span>
<span class="c1"># import warnings</span>
<span class="c1"># warnings.filterwarnings(&#39;ignore&#39;)</span>
<span class="c1"># from ipywidgets import interact, interactive, fixed, interact_manual</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="c1"># import ipywidgets as widgets</span>
<span class="c1"># import nibabel.freesurfer.mghformat as mgh</span>
<span class="c1"># import nibabel as nib</span>
<span class="c1"># import pydicom</span>
<span class="c1"># from glob import glob</span>
<span class="c1"># import os</span>
<span class="c1"># import numpy as np</span>
<span class="c1"># from nilearn.input_data import NiftiMasker</span>
<span class="c1"># from nilearn import plotting</span>
<span class="c1"># %matplotlib inline</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="mri-file-formats">
<h2>1) MRI File Formats<a class="headerlink" href="#mri-file-formats" title="Permalink to this headline">#</a></h2>
<p>All volume-based formats store 3D or 4D arrays of voxels in some fashion with a variety of additional meta-data. Anatomical images are typically 3D while EPIs are typically 4D (x,y,z, and time).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;./assets/voxel.png&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/51766c6093e1a133c9ec61543baedb8b350b9449d15057eee8ecd633ef98a8d4.png" src="../_images/51766c6093e1a133c9ec61543baedb8b350b9449d15057eee8ecd633ef98a8d4.png" />
</div>
</div>
<p><strong>voxel:</strong> A three-dimensional pixel and the basic unit of spatial measurement in MRI.</p>
<p><strong>volume:</strong> The three dimensional array covering the brain. Volumes are composed of voxels
All volume files contain both meta-data and voxels. The meta-data is just a set of information about the file’s contents while the voxels are a 3D or 4D array of values.</p>
<p><strong>slice:</strong> A two-dimensional ‘view’ of the three-dimensional volume obtained by taking all of the elements in two of the dimensions for a fixed location in the third dimension.</p>
<p><strong>Timecourse or Timeseries:</strong> a set of numbers representing a measurement (like BOLD activation) taken over time.</p>
<p>Here are the most typical file formats of neuroimaging data:</p>
<ol class="arabic simple">
<li><p><em>DICOM (.dcm, .ima)</em> \</p></li>
<li><p><em>NIFTI (.nii/nii.gz, gii.gz)</em> \</p></li>
<li><p><em>MGH (.mgh, .mgz)</em> \</p></li>
<li><p>Custom (.dtseries, .label, .surf)</p></li>
</ol>
</section>
<section id="dicom-file-format">
<h2>DICOM file format<a class="headerlink" href="#dicom-file-format" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Single slice of Brain MRI</span>

<span class="c1"># dcm_path = &#39;/workspace/data/Brats_kaggle/DICOM/00008/T1w/&#39;</span>
<span class="c1"># g = glob(os.path.join(dcm_path, &#39;*&#39;))</span>
<span class="c1"># !tree ./data/Brats_kaggle/DICOM/ --filelimit 2</span>

<span class="c1"># # Print out the first 5 file names to verify we&#39;re in the right folder.</span>

<span class="c1"># print(&#39;Total of %d DICOM images.\nFirst 5 filenames:&#39; % len(g))</span>
<span class="c1"># print(&#39;Standart DICOM directory tree: \n&#39;)</span>
<span class="c1"># print(&#39;\n&#39;.join(g[:]))</span>
</pre></div>
</div>
</div>
</div>
<p>Common MRI DICOM sctructure</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dcm_file = pydicom.dcmread(os.path.join(dcm_path, &#39;Image-20.dcm&#39;))</span>
<span class="c1"># plt.imshow(dcm_file.pixel_array, cmap=&#39;gray&#39;, origin=&#39;upper&#39;)</span>
<span class="c1"># rows = int(dcm_file.Rows)</span>
<span class="c1"># cols = int(dcm_file.Columns)</span>
<span class="c1"># print(&#39;Dimension of one dcm file:&#39;, dcm_file.pixel_array.shape)</span>
<span class="c1"># plt.show()</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Lets stack all DICOM’s and plot em aall:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># def load_scan(path):</span>
<span class="c1">#     slices = [pydicom.dcmread(dcm_path + &#39;/&#39; + s) for s in os.listdir(dcm_path)]</span>
<span class="c1">#     slices.sort(key = lambda x: int(x.InstanceNumber))</span>
<span class="c1">#     try:</span>
<span class="c1">#         slice_thickness = np.abs(slices[0].ImagePositionPatient[2] - slices[1].ImagePositionPatient[2])</span>
<span class="c1">#     except:</span>
<span class="c1">#         slice_thickness = np.abs(slices[0].SliceLocation - slices[1].SliceLocation)</span>
        
<span class="c1">#     for s in slices:</span>
<span class="c1">#         s.SliceThickness = slice_thickness</span>
    
<span class="c1">#     image = np.stack([s.pixel_array for s in slices])</span>
<span class="c1">#     return np.array(image)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dcm_stack = load_scan(dcm_path)</span>
<span class="c1"># rows=3</span>
<span class="c1"># cols=3</span>
<span class="c1"># start_with=5</span>
<span class="c1"># show_every=3</span>
<span class="c1"># fig,ax = plt.subplots(rows,cols,figsize=[15,15])</span>
<span class="c1"># for i in range(rows*cols):</span>
<span class="c1">#     ind = start_with + i*show_every</span>
<span class="c1">#     ax[int(i/rows),int(i % rows)].imshow(dcm_stack[ind],cmap=&#39;gray&#39;, origin=&quot;upper&quot;)</span>
<span class="c1">#     ax[int(i/rows),int(i % rows)].set_title(&#39;slice %d&#39; % ind)</span>
<span class="c1">#     ax[int(i/rows),int(i % rows)].set_xlabel(&#39;xlabel&#39;)</span>
<span class="c1">#     ax[int(i/rows),int(i % rows)].set_ylabel(&#39;ylabel&#39;)</span>
<span class="c1"># plt.show()</span>
</pre></div>
</div>
</div>
</div>
<p><strong>DICOM Headers</strong></p>
<p>Another good way to look at the meta-data in a volume file is to load it with the relevant programming environment and examine the data-structures there. Here are a few examples.
Accordingly, we need to be able to, at a minimum, store some amount of information about the coordinate system employed in any MRI volume file, and ideally some amount of information about how to precisely align the brain to some standard orientation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pat_name = dcm_file.PatientName</span>
<span class="c1"># display_name = pat_name.family_name + &quot;, &quot; + pat_name.given_name</span>
<span class="c1"># print(&quot;Patient id.......:&quot;, dcm_file.PatientID)</span>
<span class="c1"># print(&quot;Modality.........:&quot;, dcm_file.Modality)</span>
<span class="c1"># print(&quot;Rows.............:&quot;, dcm_file.Rows)</span>
<span class="c1"># print(&quot;Columns..........:&quot;, dcm_file.Columns)</span>
<span class="c1"># print(&quot;Pixel Spacing....:&quot;, dcm_file.PixelSpacing)</span>
<span class="c1"># print(&quot;Slide Thickness.:&quot;, dcm_file.SliceThickness)</span>
<span class="c1"># print(&quot;Patient Position.:&quot;, dcm_file.PatientPosition)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># #dcm_header = pydicom.dcmread(dcm_file)</span>
<span class="c1"># dcm_file</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-manipulations">
<h2>Data manipulations<a class="headerlink" href="#data-manipulations" title="Permalink to this headline">#</a></h2>
<p>Assume that you recieved new dicom from hospital or downloaded challenge data and you need to convert to convinient NIFTI, let’s review the tool distinctive from simple one represented above:</p>
<p><strong>dcm2niix</strong> <br />
Robust .dcm to nii/nii.gz converter. Params <em>%i</em> <em>%n</em> <em>%p</em> stands for patient ID, subject name, protocol name DICOM header keys. Try to run with params %p_%t_%s \</p>
<p><a class="reference external" href="https://www.nitrc.org/plugins/mwiki/index.php/dcm2nii:MainPage#General_Usage">https://www.nitrc.org/plugins/mwiki/index.php/dcm2nii:MainPage#General_Usage</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !dcm2niix -o /workspace/ -f %i_%n_%p -z y ./data/Brats_kaggle/DICOM/00008/T1w</span>
</pre></div>
</div>
</div>
</div>
<p>Plotting results of convertation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plotting.plot_anat(&#39;/workspace/00008_00008_T1w.nii.gz&#39;, bg_img=None)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="nifti-file-format">
<h2>Nifti File Format<a class="headerlink" href="#nifti-file-format" title="Permalink to this headline">#</a></h2>
<p>The Neuroimaging Informatics Technology Initiative (nifti) is format to store radiological information, the first three dimensions are reserved to define the three spatial dimensions — x, y and z —, while the fourth dimension is reserved to define the time points — t. The remaining dimensions, from fifth to seventh, are for other uses. The fifth dimension, however, can still have some predefined uses, such as to store voxel-specific distributional parameters or to hold vector-based data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># nii_file = nib.load(&#39;/workspace/00008_00008_T1w.nii.gz&#39;)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="nifti-header">
<h2>Nifti Header<a class="headerlink" href="#nifti-header" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># nii_header = nii_file.header</span>
<span class="c1"># print(&quot;Image dimensions...........................:&quot;, nii_header[&#39;dim&#39;])</span>
<span class="c1"># print(&quot;Voxel size and time interval...............:&quot;, nii_header[&#39;pixdim&#39;])</span>
<span class="c1"># print(&quot;Slice Order................................:&quot;, nii_header[&#39;slice_code&#39;])</span>
<span class="c1"># print(&quot;Human readable text........................:&quot;, nii_header[&#39;descrip&#39;])</span>
<span class="c1"># print(&quot;Three rows of sform affine transformation..:&quot;&#39;\n&#39;, nii_header[&#39;srow_x&#39;],&#39;\n&#39;, nii_header[&#39;srow_y&#39;],&#39;\n&#39;, nii_header[&#39;srow_z&#39;])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="mgh-file-format">
<h2>MGH File Format<a class="headerlink" href="#mgh-file-format" title="Permalink to this headline">#</a></h2>
<p><strong>MGH File Format</strong> is a default format of <em>freesurfer</em> preprocessing software. That can do the following</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;./assets/freesurfer.png&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0ce80cf1516a95a6b080a7b4b95a4271b15d80d61e90aea1e58f2c34f1fffc3d.png" src="../_images/0ce80cf1516a95a6b080a7b4b95a4271b15d80d61e90aea1e58f2c34f1fffc3d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mgh_file = mgh.load(&#39;./data/freesurfer_preproc/100206/mri/T1.mgz&#39;)</span>
<span class="c1"># mgh_file.get_fdata().shape</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Define plot function</span>
<span class="c1"># def show_slices(image, axis1=&quot;x&quot;, axis2=&quot;y&quot;, axis3=&quot;z&quot;):</span>
<span class="c1">#     slice_0 = image[round(len(image[0])/2), :, :]</span>
<span class="c1">#     slice_1 = image[:, round(len(image[1])/2), :]</span>
<span class="c1">#     slice_2 = image[:, :, round(len(image[2])/2)]</span>
<span class="c1">#     image = ([slice_0, slice_1, slice_2])</span>
<span class="c1">#     fig, axes = plt.subplots(1, len(image), figsize=[15,15])</span>
<span class="c1">#     for i, slice in enumerate(image):</span>
<span class="c1">#         axes[i].imshow(slice.T, cmap=&quot;gray&quot;, origin=&quot;upper&quot;)</span>
<span class="c1">#         axes[0].set(xlabel=axis2, ylabel=axis3)</span>
<span class="c1">#         axes[1].set(xlabel=axis1, ylabel=axis3)</span>
<span class="c1">#         axes[2].set(xlabel=axis1, ylabel=axis2)</span>
<span class="c1">#     plt.show()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mgh_image = np.array(mgh_file.dataobj).astype(np.float64)</span>
<span class="c1"># show_slices(mgh_image)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>MGH Header</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mgh_header = mgh_file.header</span>
<span class="c1"># print(&quot;Image dimensions........:&quot;, mgh_header[&#39;dims&#39;])</span>
<span class="c1"># print(&quot;Orientation matrix...: &quot;&#39;\n&#39;, mgh_header.get_affine())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plotting.plot_anat(mgh_file, bg_img=None)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;./assets/Orientation.png&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b4c8a6a449bc7144cd1238443b5e1cf90cdcb0010d4bd2d578f412cfd42c403c.png" src="../_images/b4c8a6a449bc7144cd1238443b5e1cf90cdcb0010d4bd2d578f412cfd42c403c.png" />
</div>
</div>
<p>DICOM patient coordinate and Nifti coodrinate system when Patient is Head First Supine. The arrows of axes indicate the positive directions, LPS for DICOM and RAS for Nifti. For Dicom images, the origin (0,0,0) refers to magnet isocenter.</p>
<p><em>Voxel size</em> and <em>Pixel spacing</em> are important as we for preprocessing we can use only isomorphic voxel</p>
<p><strong>BIDS</strong> Brain Imaging Data Structure. <br />
Simplify representation of DICOM neuroimaging data and grants huge advantages for experiments and version control of dataset. Moreover, reduces dataset storage range.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;./assets/BIDS.png&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d7ef48655b4a606a0adf460d10a4bf12c68e38c0e02be1502d887bac092fd861.png" src="../_images/d7ef48655b4a606a0adf460d10a4bf12c68e38c0e02be1502d887bac092fd861.png" />
</div>
</div>
<p>There is a few robust DICOM converters:</p>
<blockquote>
<div><p><strong>HeudiConv</strong></p>
</div></blockquote>
<blockquote>
<div><p><strong>dcm2bids</strong></p>
</div></blockquote>
<p>They both use DICOM headers, to distinquish sequence protocols. So fully anonomized DICOMs can’t be converted using this software.
Let’s look how <em>heudiconv</em> runs:
First you should implement <a class="reference external" href="http://heudiconv.py">heudiconv.py</a>.
The only required function for a heuristic, <em>infotodict</em> is used to both define the conversion outputs and specify the criteria for scan to output association. Conversion outputs are defined as keys, a tuple consisting of a template path used for the basis of outputs, as well as a tuple of output types. Valid types include nii, nii.gz, and dicom.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !/opt/miniconda-latest/envs/neuro/bin/heudiconv -d /workspace/data/Brats_kaggle/DICOM/{subject}/*/* \</span>
<span class="c1">#     -f /workspace/heuristic.py \</span>
<span class="c1">#     -s 00008 \</span>
<span class="c1">#     -c dcm2niix \</span>
<span class="c1">#     -b --overwrite \</span>
<span class="c1">#     -o /workspace/BIDS &gt; /workspace/heudiconv_log 2&gt;&amp;1</span>
</pre></div>
</div>
</div>
</div>
<p>Heudiconv output BIDS directory tree:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !tree /workspace/BIDS</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !rm -r /workspace/BIDS/*</span>
<span class="c1"># !rm -r /workspace/BIDS/.heudiconv</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./seminar2"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../seminar1/seminar1-working-with-eeg.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Seminar 1. EEG analysis</p>
      </div>
    </a>
    <a class="right-next"
       href="seminar2_2_transform.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Transformations</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plan">PLAN:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mri-file-formats">1) MRI File Formats</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dicom-file-format">DICOM file format</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-manipulations">Data manipulations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nifti-file-format">Nifti File Format</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nifti-header">Nifti Header</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mgh-file-format">MGH File Format</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Nadezhda Alsahanova
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>